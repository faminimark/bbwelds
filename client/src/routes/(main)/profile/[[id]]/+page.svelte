<script lang="ts">
    import { Display } from '$lib/components/Fields'
    import Card from '$lib/components/Card.svelte'
    import { ShareButton } from '$lib/components/Buttons'
    import BackButton from '$lib/components/BackButton.svelte'
    import Carousel from '$lib/components/Carousel.svelte'
    import Edit from '$lib/components/Profile/Edit.svelte'
    import Modal from '$lib/components/Modal/index'
    import Masonry from '$lib/components/Masonry.svelte'
    
    import { generateFromString } from 'generate-avatar'
    import type { PostsByYear } from './types';
    import { redirect } from '@sveltejs/kit';
    import { MessageSquare, PencilIcon, Plus } from 'lucide-svelte'
    import { Centered } from '$lib/components/Dividers';
    
    const { data } = $props()
    const current_user = data?.user
    const user = data.data
    const posts: PostsByYear = user.posts;
    if(!user) throw redirect(302, `/`)

    const isCurrentUser = Boolean(current_user && user.user_id === current_user?.user_id)
    const location = user?.locations
    const contacts = user?.contacts
    const avatar = user?.profile_image?.image_url
    const imageURL = Boolean(avatar) ? avatar :  `data:image/svg+xml;utf8,${generateFromString(user.user_id)}`
</script>


<div class="flex flex-col gap-7">
    <BackButton />
    <div class="flex flex-col gap-7 w-full">
        <div class="flex flex-col gap-3">
            <div class="flex flex-col gap-3">
                <h2 class="text-2xl font-semibold text-gray-700 flex justify-between">{ user.fullname } 
                    <ShareButton />
               </h2>
                
                <div class="flex flex-col gap-3">
                    <div class="bg-gray-300 flex w-full justify-center py-4">
                        <img aria-label="profile pic" alt="profile pic" src="{imageURL}" class="max-w-3/4" />
                    </div>
                    <!-- If user then edit profile otherwise send message -->
                    {#if isCurrentUser}
                        <div>
                            <Modal label={'Edit Profile'} title={"Edit Profile"} Icon={PencilIcon}>
                                <Edit user={user}/>
                            </Modal>
                        </div> 
                    {:else}
                        <div class="flex justify-between">
                            <button class="flex gap-2 cursor-pointer font-semibold p-3 text-gray-700 rounded-md hover:bg-gray-100 border-gray-700">
                                <MessageSquare class="w-[25px]"/> Send message
                            </button>
                            <button class="text-gray-300 font-light text-sm cursor-pointer">
                                Report User
                            </button>
                        </div>
                    {/if}
                   
                </div>
            </div>
            <div class="flex flex-col gap-12 max-md:gap-4">
                
                <div>
                    <header class="font-semibold text-sm">About</header>
                    <p class="max-w-[400px] text-sm text-gray-500">
                        { user.profile_description }
                    </p>
                </div>
                <div class="flex flex-col gap-3">
                    {#each contacts as contact}
                        <Display title={contact.contact_type} value={contact.value}/>
                    {/each}
                    <Display title="Location" value={`${location.city}, ${location.state_region} ${location.zip_postal} ${location.country}`}/>
                    <Display title="License #" value={'999999999'}/>
                    <Display title="Cerifications" value={["AWS 6G", "Certified Rap battle champion", "Certified Lover boy"]} />
                </div>
            </div>
        </div>
    </div>
    <div class="flex flex-col gap-6">
        <div class="flex flex-row justify-between">
            <h2  class="text-2xl">Portfolio</h2>
            {#if isCurrentUser}
            <div class="flex gap-4">
                <button class="flex gap-2 cursor-pointer font-semibold p-3 text-gray-700 rounded-md  border-gray-700  hover:bg-gray-100">
                    <PencilIcon class="w-[20px]"/> <span class="max-sm:hidden">Edit Gallery</span>
                </button>
                <button class="flex gap-2 cursor-pointer font-semibold p-3 text-gray-700 rounded-md  border-gray-700  hover:bg-gray-100">
                    <Plus class="w-[20px]"/> <span class="max-sm:hidden">Add to Gallery</span>
                </button>
            </div>
            {/if}
        </div>
        <!-- Make the post here sorted by date -->
        {#if posts.length}
            {#each posts as yearGroup}
                <div class="flex flex-col gap-8">
                        {#each Object.entries(yearGroup) as [year, posts]}
                        <div class="flex flex-col gap-6">
                            <Centered text={year}/>
                            <Masonry columns={{lg: 3, md: 2, sm: 1}} gap={14}>
                                {#each posts as {images, post_id}}
                                    <Carousel image_count={images.length} >
                                        {#each images as image}
                                            <a href="/post/{post_id}" class="embla__slide w-full flex shrink-0 grow-0 basis-full">
                                                <img aria-label="feed" alt="feed" src={image.image_url} class="w-full h-full object-cover aspect-auto" />
                                            </a>
                                        {/each}
                                    </Carousel>
                                {/each}
                            </Masonry>
                        </div>
                        {/each}
                </div>
            {/each}
        {:else}
            <div class="text-center w-full py-5 text-lg">
                {user.f_name} is still working on his Portfolio!
            </div>
        {/if}
    </div>
</div>